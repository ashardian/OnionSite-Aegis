version: '3.8'

services:
  aegis:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: onionsite-aegis
    restart: unless-stopped
    
    # Security: Run with minimal capabilities
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for binding to ports < 1024
      - CHOWN              # Required for Tor
      - SETUID             # Required for Tor
      - SETGID             # Required for Tor
      - DAC_OVERRIDE      # Required for file operations
    
    # Security: Read-only root filesystem where possible
    read_only: false  # Tor and Nginx need write access for logs and runtime data
    
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
      - seccomp:./seccomp-profile.json  # Custom seccomp profile
    
    # Network isolation
    networks:
      - aegis-internal
    
    # Volumes
    volumes:
      # Persistent storage for Tor keys (critical - don't lose these!)
      - onion-keys:/var/lib/tor/hidden_service:rw
      # Web content
      - ./webroot:/var/www/onion_site:ro  # Read-only web content
      # RAM logs (tmpfs for privacy)
      - type: tmpfs
        target: /mnt/ram_logs
        tmpfs:
          size: 256M
          mode: 1777
          noexec: true
          nosuid: true
          nodev: true
      # Optional: Mount custom configs
      # - ./custom-torrc:/etc/tor/torrc:ro
    
    # Resource limits (prevent resource exhaustion attacks)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Environment variables
    environment:
      - TZ=UTC
      - TOR_CONTROL_PORT=9051
      - WEB_ROOT=/var/www/onion_site
    
    # Health check (requires curl in container)
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/lib/tor/hidden_service/hostname && curl -f http://127.0.0.1:8080/ >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging (optional - for debugging, remove in production for privacy)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "privacy-focused"
    
    # User (run as non-root where possible)
    # Note: Tor requires root or specific user, so we use debian-tor
    user: "0:0"  # Root required for Tor, but container is isolated
    
    # Working directory
    working_dir: /var/www/onion_site
    
    # Command
    command: ["aegis"]

# Named volumes
volumes:
  onion-keys:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/tor-keys  # Local directory for persistence

# Networks
networks:
  aegis-internal:
    driver: bridge
    internal: true  # No external access
    ipam:
      config:
        - subnet: 172.28.0.0/16

