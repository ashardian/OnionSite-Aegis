server {
    listen 127.0.0.1:8080 default_server;
    server_name localhost;
    root /var/www/onion_site;
    index index.html;
    
    # --- ACTIVATE WAF ---
    modsecurity on;
    modsecurity_rules_file /etc/nginx/modsec/main.conf;
    
    # Privacy & Anti-Fingerprinting
    server_tokens off;
    more_clear_headers Server;
    more_clear_headers 'X-Powered-By';
    more_clear_headers 'X-AspNet-Version';
    more_clear_headers 'X-AspNetMvc-Version';
    
    # Disable compression (prevents size-based correlation attacks)
    gzip off;
    gzip_vary off;
    
    # Remove tracking headers (ETag, Last-Modified can be used for tracking)
    etag off;
    more_clear_headers 'ETag';
    more_clear_headers 'Last-Modified';
    more_clear_headers 'If-Modified-Since';
    more_clear_headers 'If-None-Match';
    
    # Buffer Overflow Protection
    client_body_buffer_size 1k;
    client_header_buffer_size 1k;
    client_max_body_size 1k;
    large_client_header_buffers 2 1k;

    # Anti-Slowloris Timeouts (with randomization for privacy)
    client_body_timeout 10;
    client_header_timeout 10;
    keepalive_timeout 3 3;  # Reduced and randomized to prevent correlation
    send_timeout 10;
    
    # Response timing randomization (via Lua or post_action)
    # This helps prevent timing-based correlation attacks
    
    # Rate Limiting (Privacy Protection)
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
    limit_req zone=req_limit burst=5 nodelay;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    limit_conn conn_limit 5;

    # Privacy-Focused Headers (Anti-Tracking)
    add_header X-Frame-Options "DENY" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'none'; object-src 'none'; frame-ancestors 'none';" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Additional Anti-Tracking Headers
    add_header Clear-Site-Data '"cache", "cookies", "storage"' always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    
    # Remove identifying headers (if headers-more module available)
    more_clear_headers 'X-Request-ID';
    more_clear_headers 'X-Forwarded-For';
    more_clear_headers 'X-Real-IP';
    more_clear_headers 'Via';
    more_clear_headers 'X-Forwarded-Proto';
    more_clear_headers 'X-Forwarded-Host';
    more_clear_headers 'X-Original-URL';
    more_clear_headers 'X-Rewrite-URL';
    
    # Disable access logs (privacy - logs are in RAM anyway)
    access_log off;
    log_not_found off;
    
    # Error pages without information leakage
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # Security: Disable directory listing
    autoindex off;
    
    # Block common attack vectors
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~* \.(php|sh|py|pl|rb|exe|bin)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Response size padding (prevents traffic analysis)
    # Pad all responses to uniform sizes to prevent size-based correlation
    # This is critical for preventing traffic analysis attacks
    
    # Main location block
    location / {
        try_files $uri $uri/ =404;
        
        # Additional privacy headers per location
        add_header Cache-Control "no-store, no-cache, must-revalidate, private, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Response padding (add random padding to prevent size correlation)
        # Note: This requires nginx-lua module for full implementation
        # For now, we ensure uniform error responses
    }
    
    # Uniform error responses (same size to prevent correlation)
    # All 404s should be identical size
    error_page 404 =404 /404.html;
    error_page 500 502 503 504 =500 /50x.html;
    
    # Minimal error pages
    location = /404.html {
        internal;
        root /var/www/onion_site;
    }
    
    location = /50x.html {
        internal;
        root /var/www/onion_site;
    }
}
