server {
    listen 127.0.0.1:8080 default_server;
    server_name localhost;
    root /var/www/onion_site;
    index index.html;
    
    # --- ACTIVATE WAF ---
    modsecurity on;
    modsecurity_rules_file /etc/nginx/modsec/main.conf;
    
    # Privacy & Anti-Fingerprinting
    server_tokens off;
    # Remove identifying headers (requires headers-more module, fallback handled)
    
    # Buffer Overflow Protection
    client_body_buffer_size 1k;
    client_header_buffer_size 1k;
    client_max_body_size 1k;
    large_client_header_buffers 2 1k;

    # Anti-Slowloris Timeouts
    client_body_timeout 10;
    client_header_timeout 10;
    keepalive_timeout 5 5;
    send_timeout 10;
    
    # Rate Limiting (Privacy Protection)
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
    limit_req zone=req_limit burst=5 nodelay;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    limit_conn conn_limit 5;

    # Privacy-Focused Headers
    add_header X-Frame-Options "DENY" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'none'; object-src 'none'; frame-ancestors 'none';" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Remove identifying headers (if headers-more module available)
    # Note: Standard nginx will still show some headers, but privacy is maintained
    
    # Disable access logs (privacy - logs are in RAM anyway)
    access_log off;
    
    # Error pages without information leakage
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # Security: Disable directory listing
    autoindex off;
    
    # Block common attack vectors
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~* \.(php|sh|py|pl|rb|exe|bin)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Main location block
    location / {
        try_files $uri $uri/ =404;
        
        # Additional privacy headers per location
        add_header Cache-Control "no-store, no-cache, must-revalidate, private" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
    
    # Minimal error pages
    location = /404.html {
        internal;
        root /var/www/onion_site;
    }
    
    location = /50x.html {
        internal;
        root /var/www/onion_site;
    }
}
