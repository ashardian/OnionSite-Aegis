#!/usr/sbin/nft -f
# Enhanced NFTables Firewall Configuration
# Privacy-Focused with DDoS Protection

flush ruleset

# Define sets for rate limiting and blacklisting
table inet filter {
    # Rate limiting sets
    set syn_flood {
        type ipv4_addr
        flags timeout
        timeout 60s
        size 65535
    }
    
    set connection_limit {
        type ipv4_addr
        flags timeout
        timeout 300s
        size 65535
    }
    
    set rate_limit {
        type ipv4_addr
        flags timeout
        timeout 10s
        size 65535
    }
    
    # Connection tracking limits
    set conn_limit_per_ip {
        type ipv4_addr
        flags timeout
        timeout 60s
        size 65535
    }
    
    # Chain for input filtering
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Allow loopback (Critical for Nginx<->Tor communication)
        iifname "lo" accept
        
        # Drop invalid packets immediately
        ct state invalid drop
        
        # Allow established and related connections
        ct state established,related accept
        
        # SYN Flood Protection
        tcp flags syn tcp flags & (syn|ack) == syn \
            limit rate 25/second burst 50 packets \
            add @syn_flood { ip saddr } \
            accept
        
        # Drop excessive SYN packets
        tcp flags syn tcp flags & (syn|ack) == syn \
            ip saddr @syn_flood drop
        
        # Connection rate limiting per IP
        tcp flags syn \
            add @rate_limit { ip saddr limit rate over 10/minute } \
            drop
        
        # Limit new connections per IP (max 5 per minute)
        ct state new \
            add @conn_limit_per_ip { ip saddr ct count over 5 } \
            drop
        
        # ICMP handling (minimal, only essential types)
        icmp type { echo-request, echo-reply, destination-unreachable, time-exceeded } \
            limit rate 1/second accept
        icmpv6 type { echo-request, echo-reply, destination-unreachable, time-exceeded } \
            limit rate 1/second accept
        
        # Drop all other ICMP
        icmp drop
        icmpv6 drop
        
        # Allow Tor control port (localhost only)
        tcp dport 9051 iifname "lo" accept
        
        # Allow Tor SOCKS port (localhost only)
        tcp dport 9050 iifname "lo" accept
        
        # Allow Nginx (localhost only)
        tcp dport 8080 iifname "lo" accept
        
        # SSH (optional - uncomment if needed)
        # tcp dport 22 limit rate 3/minute accept
        
        # Log and drop everything else
        log prefix "FIREWALL-DROP: " drop
    }
    
    # Chain for forward filtering (drop all)
    chain forward {
        type filter hook forward priority 0; policy drop;
        log prefix "FIREWALL-FORWARD-DROP: " drop
    }
    
    # Chain for output (allow all, but log suspicious)
    chain output {
        type filter hook output priority 0; policy accept;
        
        # Log suspicious outbound connections (for monitoring)
        # Uncomment to enable logging:
        # tcp dport != { 80, 443, 53, 9050, 9051 } log prefix "OUTBOUND: " accept
    }
    
    # Chain for prerouting (early packet processing)
    chain prerouting {
        type filter hook prerouting priority -300; policy accept;
        
        # Early drop of invalid packets
        ct state invalid drop
        
        # Fragment protection
        ip frag-off & 0x1fff != 0 counter drop
    }
}

# Additional table for connection tracking limits
table inet raw {
    chain prerouting {
        type filter hook prerouting priority -300; policy accept;
        
        # Limit connection tracking table size
        ct state invalid drop
    }
    
    chain output {
        type filter hook output priority -300; policy accept;
    }
}
