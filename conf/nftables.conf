#!/usr/sbin/nft -f
# Enhanced NFTables Firewall Configuration
# Privacy-Focused with DDoS Protection

flush ruleset

# Define sets for rate limiting and blacklisting
table inet filter {
    # Rate limiting sets
    set syn_flood {
        type ipv4_addr;
        flags timeout;
        timeout 60s;
        size 65535;
    }

    set connection_limit {
        type ipv4_addr;
        flags timeout;
        timeout 300s;
        size 65535;
    }

    set rate_limit {
        type ipv4_addr;
        flags timeout;
        timeout 10s;
        size 65535;
    }

    # Connection tracking limits
    set conn_limit_per_ip {
        type ipv4_addr;
        flags timeout;
        timeout 60s;
        size 65535;
    }


    # Chain for input filtering
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback (Critical for Nginx<->Tor communication)
        iifname "lo" accept

        # Drop invalid packets immediately
        ct state invalid drop

        # Allow established and related connections
        ct state established,related accept

        # SYN Flood Protection
        tcp flags syn ct state new limit rate 25/second burst 50 packets add @syn_flood { ip saddr } accept

        # Drop excessive SYN packets
        tcp flags syn ct state new ip saddr @syn_flood drop

        # Connection rate limiting (10 SYN packets per minute globally)
        tcp flags syn ct state new limit rate 10/minute accept

        # Limit new connections (max 5 per minute globally)
        ct state new limit rate 5/minute accept

        # ICMP handling (minimal, only essential types)
        ip protocol icmp icmp type { echo-request, echo-reply, destination-unreachable, time-exceeded } limit rate 1/second accept
        ip6 nexthdr icmpv6 icmpv6 type { echo-request, echo-reply, destination-unreachable, time-exceeded } limit rate 1/second accept

        # Drop all other ICMP (explicit for clarity)
        ip protocol icmp icmp type != { echo-request, echo-reply, destination-unreachable, time-exceeded } drop
        ip6 nexthdr icmpv6 icmpv6 type != { echo-request, echo-reply, destination-unreachable, time-exceeded } drop

        # Allow Tor control port (localhost only)
        tcp dport 9051 iifname "lo" accept

        # Allow Tor SOCKS port (localhost only)
        tcp dport 9050 iifname "lo" accept

        # Allow Nginx (localhost only)
        tcp dport 8080 iifname "lo" accept

        # SSH (optional - uncomment if needed)
        # tcp dport 22 limit rate 3/minute accept

        # Log and drop everything else
        log prefix "FIREWALL-DROP: " drop
    }

    # Chain for forward filtering (drop all)
    chain forward {
        type filter hook forward priority 0; policy drop;
        log prefix "FIREWALL-FORWARD-DROP: " drop
    }

    # Chain for output (allow all, but log suspicious)
    chain output {
        type filter hook output priority 0; policy accept;

        # Log suspicious outbound connections (for monitoring)
        # Uncomment to enable logging:
        # tcp dport != { 80, 443, 53, 9050, 9051 } log prefix "OUTBOUND: " accept
    }

    # Prerouting chain is not valid for 'filter' tables in nftables, removing it.
}

# Remove invalid 'prerouting' and 'output' chains from the 'raw' table.
table inet raw {
    chain prerouting {
        type filter hook prerouting priority -300; policy accept;

        # Limit connection tracking table size
        ct state invalid drop
    }
}
